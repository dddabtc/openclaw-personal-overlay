From 60d4f375779672747e551597fc235486096cbb54 Mon Sep 17 00:00:00 2001
From: zhaod <zhaod@local>
Date: Fri, 20 Feb 2026 14:47:35 -0400
Subject: [PATCH 13/20] fix: make transient retry delay abortable


diff --git a/src/auto-reply/reply/agent-runner-execution.ts b/src/auto-reply/reply/agent-runner-execution.ts
index 4becf72c780eaff941f4e31f8572e7f31087e96e..cc414d1c2fac50b69a77f2a99005e00c283a1876 100644
--- a/src/auto-reply/reply/agent-runner-execution.ts
+++ b/src/auto-reply/reply/agent-runner-execution.ts
@@ -1,5 +1,6 @@
 import crypto from "node:crypto";
 import fs from "node:fs";
+import { setTimeout as delay } from "node:timers/promises";
 import { runCliAgent } from "../../agents/cli-runner.js";
 import { getCliSessionId } from "../../agents/cli-session.js";
 import { runWithModelFallback } from "../../agents/model-fallback.js";
@@ -543,10 +544,14 @@ export async function runAgentTurnWithFallback(params: {
         defaultRuntime.error(
           `Transient HTTP provider error before reply (${message}). Retrying once in ${TRANSIENT_HTTP_RETRY_DELAY_MS}ms.`,
         );
-        await new Promise<void>((resolve) => {
-          setTimeout(resolve, TRANSIENT_HTTP_RETRY_DELAY_MS);
-        });
-        continue;
+        try {
+          await delay(TRANSIENT_HTTP_RETRY_DELAY_MS, undefined, {
+            signal: params.opts?.abortSignal,
+          });
+          continue;
+        } catch {
+          // Abort should short-circuit the retry wait and fall through to final error handling.
+        }
       }
 
       defaultRuntime.error(`Embedded agent failed before reply: ${message}`);
diff --git a/src/auto-reply/reply/agent-runner.misc.runreplyagent.test.ts b/src/auto-reply/reply/agent-runner.misc.runreplyagent.test.ts
index a1ad2d0a9128272535a0b4a89b79c20e480557be..0df2bf0c9eefc254ba05742ca86ce77a78c02950 100644
--- a/src/auto-reply/reply/agent-runner.misc.runreplyagent.test.ts
+++ b/src/auto-reply/reply/agent-runner.misc.runreplyagent.test.ts
@@ -1359,4 +1359,73 @@ describe("runReplyAgent transient HTTP retry", () => {
     const payload = Array.isArray(result) ? result[0] : result;
     expect(payload?.text).toContain("Recovered response");
   });
+
+  it("aborts transient retry delay immediately when abort signal fires", async () => {
+    vi.useFakeTimers();
+    runEmbeddedPiAgentMock.mockRejectedValueOnce(new Error("521 Cloudflare"));
+
+    const typing = createMockTypingController();
+    const sessionCtx = {
+      Provider: "telegram",
+      MessageSid: "msg",
+    } as unknown as TemplateContext;
+    const resolvedQueue = { mode: "interrupt" } as unknown as QueueSettings;
+    const followupRun = {
+      prompt: "hello",
+      summaryLine: "hello",
+      enqueuedAt: Date.now(),
+      run: {
+        sessionId: "session",
+        sessionKey: "main",
+        messageProvider: "telegram",
+        sessionFile: "/tmp/session.jsonl",
+        workspaceDir: "/tmp",
+        config: {},
+        skillsSnapshot: {},
+        provider: "anthropic",
+        model: "claude",
+        thinkLevel: "low",
+        verboseLevel: "off",
+        elevatedLevel: "off",
+        bashElevated: {
+          enabled: false,
+          allowed: false,
+          defaultLevel: "off",
+        },
+        timeoutMs: 1_000,
+        blockReplyBreak: "message_end",
+      },
+    } as unknown as FollowupRun;
+
+    const abort = new AbortController();
+    const runPromise = runReplyAgent({
+      commandBody: "hello",
+      followupRun,
+      queueKey: "main",
+      resolvedQueue,
+      shouldSteer: false,
+      shouldFollowup: false,
+      isActive: false,
+      isStreaming: false,
+      typing,
+      sessionCtx,
+      opts: { abortSignal: abort.signal },
+      defaultModel: "anthropic/claude-opus-4-5",
+      resolvedVerboseLevel: "off",
+      isNewSession: false,
+      blockStreamingEnabled: false,
+      resolvedBlockStreamingBreak: "message_end",
+      shouldInjectGroupIntro: false,
+      typingMode: "instant",
+    });
+
+    abort.abort(new Error("manual abort"));
+    await vi.advanceTimersByTimeAsync(1);
+    const result = await runPromise;
+
+    expect(runEmbeddedPiAgentMock).toHaveBeenCalledTimes(1);
+    const payload = Array.isArray(result) ? result[0] : result;
+    expect(String(payload?.text ?? "")).toContain("Agent failed before reply");
+  });
+
 });
-- 
2.25.1

