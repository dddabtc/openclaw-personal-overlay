name: support-release-rollover

"on":
  workflow_dispatch: {}
  push:
    branches: [main]
    paths:
      - 'compatibility.json'
      - '.github/workflows/support-release-rollover.yml'

permissions:
  contents: write

jobs:
  publish-and-prune:
    runs-on: ubuntu-latest
    env:
      KEEP_SUPPORT_BRANCHES: '20'
      REPO: dddabtc/openclaw-personal-overlay
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve latest non-deprecated compatibility entry
        id: latest
        run: |
          set -euo pipefail
          row=$(jq -r '.supported[] | select((.status // "") != "deprecated") | select(.openclawVersion and .commitSha) | "\(.openclawVersion) \(.commitSha)"' compatibility.json | head -n1)
          if [[ -z "${row:-}" ]]; then
            echo "No valid compatibility entry found" >&2
            exit 1
          fi
          VERSION="${row%% *}"
          SHA="${row#* }"
          TAG="overlay-v${VERSION}"
          BRANCH="support/v${VERSION}"

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "sha=$SHA" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

      - name: Create/update support branch for latest compatible version
        run: |
          set -euo pipefail
          BRANCH='${{ steps.latest.outputs.branch }}'
          git checkout -B "$BRANCH" origin/main
          git push origin "$BRANCH" --force-with-lease

      - name: Publish release tag for latest compatible version (idempotent)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          TAG='${{ steps.latest.outputs.tag }}'
          VERSION='${{ steps.latest.outputs.version }}'
          SHA='${{ steps.latest.outputs.sha }}'

          if gh release view "$TAG" --repo "$REPO" >/dev/null 2>&1; then
            echo "Release $TAG already exists; skip create"
          else
            gh release create "$TAG" \
              --repo "$REPO" \
              --target "${{ steps.latest.outputs.branch }}" \
              --title "$TAG" \
              --notes "Auto-published support release for OpenClaw ${VERSION}\n\ncompat: ${VERSION} @ ${SHA}\n\nSupport branch: ${{ steps.latest.outputs.branch }}"
          fi

          # Ensure official support releases always include finalized compatibility metadata.
          gh release upload "$TAG" compatibility.json --repo "$REPO" --clobber

      - name: Prune old support branches (keep latest N)
        run: |
          set -euo pipefail
          KEEP="${KEEP_SUPPORT_BRANCHES}"
          mapfile -t all < <(git for-each-ref refs/remotes/origin/support/v* --sort=-committerdate --format='%(refname:short)' | sed 's#^origin/##')
          echo "Found ${#all[@]} support branches"
          if (( ${#all[@]} <= KEEP )); then
            echo "No pruning needed"
            exit 0
          fi
          for b in "${all[@]:KEEP}"; do
            echo "Deleting old support branch: $b"
            git push origin --delete "$b" || true
          done
