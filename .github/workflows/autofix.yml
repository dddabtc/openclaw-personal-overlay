name: autofix

on:
  workflow_dispatch:
    inputs:
      reason:
        required: true
        type: string
      source_run_id:
        required: false
        type: string
        default: ''
      upstream_tag:
        required: false
        type: string
        default: ''

permissions:
  contents: write
  pull-requests: write
  actions: write
  issues: write

jobs:
  fix-and-pr:
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.cpr.outputs.pull-request-number }}
      pr_operation: ${{ steps.cpr.outputs.pull-request-operation }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Build auto-fix patch locally
        env:
          REASON: ${{ inputs.reason }}
          UPSTREAM_TAG: ${{ inputs.upstream_tag }}
        run: |
          mkdir -p .autofix
          cat > .autofix/last-run.md <<EOF
          # autofix
          reason: ${REASON}
          upstream_tag: ${UPSTREAM_TAG}
          time: $(date -u +%FT%TZ)
          EOF
      - name: Local tests (must pass)
        run: |
          python3 scripts/validate-compatibility.py compatibility.json
          bash tests/openclaw-personal.test.sh
      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          branch: autofix/${{ github.run_id }}
          commit-message: "fix(autofix): ${{ inputs.reason }}"
          title: "fix(autofix): ${{ inputs.reason }}"
          body: |
            Auto-generated by autofix workflow.

            - reason: `${{ inputs.reason }}`
            - source_run_id: `${{ inputs.source_run_id }}`
            - upstream_tag: `${{ inputs.upstream_tag }}`
          labels: |
            autofix
      - name: Ensure PR exists
        if: steps.cpr.outputs.pull-request-number == ''
        run: |
          echo "No PR created (no changes). Creating empty commit for auditability."
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -b autofix/${{ github.run_id }}-empty
          git commit --allow-empty -m "fix(autofix): empty fix marker"
          git push -u origin HEAD
          gh pr create --repo "${{ github.repository }}" --base main --head "autofix/${{ github.run_id }}-empty" \
            --title "fix(autofix): empty fix marker" --body "Auto-generated empty fix PR"
        env:
          GH_TOKEN: ${{ github.token }}

  retrigger-auto-compat:
    needs: fix-and-pr
    if: needs.fix-and-pr.outputs.pr_number != ''
    runs-on: ubuntu-latest
    steps:
      - name: Wait for PR merge
        env:
          GH_TOKEN: ${{ github.token }}
          PR: ${{ needs.fix-and-pr.outputs.pr_number }}
        run: |
          for i in $(seq 1 60); do
            merged=$(gh pr view "$PR" --repo "${{ github.repository }}" --json mergedAt --jq '.mergedAt != null')
            if [ "$merged" = "true" ]; then
              echo "PR merged"
              break
            fi
            sleep 20
          done
          merged=$(gh pr view "$PR" --repo "${{ github.repository }}" --json mergedAt --jq '.mergedAt != null')
          [ "$merged" = "true" ] || { echo "PR not merged in time"; exit 1; }
      - name: Re-trigger force auto-compat full run
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh workflow run auto-compat.yml --repo "${{ github.repository }}" -f force_full_run=true
