name: automerge-on-ci

on:
  workflow_run:
    workflows: ["ci"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  merge-autofix-pr:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Enforce single-token secret
        env:
          SINGLE_TOKEN: ${{ secrets.OC_GH_TOKEN }}
        run: |
          if [ -z "${SINGLE_TOKEN}" ]; then
            echo '{"error_code":"E_SINGLE_TOKEN_MISSING","required_secret":"OC_GH_TOKEN"}'
            exit 1
          fi

      - name: Find open PR from workflow head branch
        id: findpr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.OC_GH_TOKEN }}
          script: |
            const branch = context.payload.workflow_run.head_branch;
            if (!branch || !branch.startsWith('autofix/')) {
              core.setOutput('pr', '');
              return;
            }
            const { owner, repo } = context.repo;
            const prs = await github.rest.pulls.list({ owner, repo, state: 'open', head: `${owner}:${branch}`, per_page: 1 });
            core.setOutput('pr', prs.data.length ? String(prs.data[0].number) : '');

      - uses: actions/checkout@v4
        if: steps.findpr.outputs.pr != ''
        with:
          fetch-depth: 0
          token: ${{ secrets.OC_GH_TOKEN }}

      - name: Evaluate B+ automerge policy gate
        id: risk
        if: steps.findpr.outputs.pr != ''
        continue-on-error: true
        env:
          BASE_REF: origin/main
          HEAD_REF: HEAD
          POLICY_FILE: .github/automerge-policy.json
          RISK_REPORT: .autofix/risk-report.json
        run: python3 scripts/automerge-risk-gate.py

      - name: Persist policy block as machine-readable issue
        if: steps.findpr.outputs.pr != '' && steps.risk.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.OC_GH_TOKEN }}
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('.autofix/risk-report.json', 'utf8');
            const {owner, repo} = context.repo;
            const body = [
              'Automerge blocked by B+ policy gate.',
              '',
              'error_code: E_POLICY_GATE_BLOCKED',
              '',
              'auto_report:',
              '```json',
              report,
              '```',
              ''
            ].join('\n');
            await github.rest.issues.create({
              owner,
              repo,
              title: `automerge-blocked-pr-${{ steps.findpr.outputs.pr }}`,
              labels: ['automerge-blocked'],
              body
            });

      - name: Auto-fix PR conflicts
        id: conflicts
        if: steps.findpr.outputs.pr != '' && steps.risk.outcome == 'success'
        env:
          GH_TOKEN: ${{ secrets.OC_GH_TOKEN }}
          PR_NUMBER: ${{ steps.findpr.outputs.pr }}
          REPO: ${{ github.repository }}
          MAX_CONFLICT_FIX_ATTEMPTS: '2'
          CONFLICT_SYNC_METHOD: merge
          CONFLICT_RESOLVE_MODE: whitelist
          CONFLICT_PREFERRED_SIDE: theirs
          CONFLICT_RESOLVE_WHITELIST: compatibility.json,CHANGELOG.md,.autofix/*,.github/workflows/*
          COMMENT_ON_CONFLICT_FAILURE: 'true'
        run: scripts/resolve-pr-conflicts.sh

      - name: Skip merge and wait for next CI after conflict fix push
        if: steps.findpr.outputs.pr != '' && steps.risk.outcome == 'success' && steps.conflicts.outputs.updated == 'true'
        run: echo "Conflict fix was pushed. Waiting for next CI workflow_run to merge."

      - name: Merge PR after checks green and policy pass
        if: steps.findpr.outputs.pr != '' && steps.risk.outcome == 'success' && steps.conflicts.outputs.updated != 'true'
        env:
          GH_TOKEN: ${{ secrets.OC_GH_TOKEN }}
          PR: ${{ steps.findpr.outputs.pr }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          if gh pr merge "$PR" --repo "$REPO" --squash --delete-branch; then
            echo "Merged via normal policy path"
            exit 0
          fi
          gh pr merge "$PR" --repo "$REPO" --squash --delete-branch --admin
          echo "Merged via admin fallback"
