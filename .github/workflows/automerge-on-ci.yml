name: automerge-on-ci

on:
  workflow_run:
    workflows: ["ci"]
    types: [completed]
  workflow_dispatch:
    inputs:
      pr:
        description: "PR number for manual validation"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  resolve-pr:
    runs-on: ubuntu-latest
    outputs:
      pr: ${{ steps.resolve.outputs.pr }}
    steps:
      - name: Enforce single-token secret
        env:
          SINGLE_TOKEN: ${{ secrets.OC_GH_TOKEN }}
        run: |
          if [ -z "${SINGLE_TOKEN}" ]; then
            echo '{"error_code":"E_SINGLE_TOKEN_MISSING","required_secret":"OC_GH_TOKEN"}'
            exit 1
          fi

      - name: Resolve target PR (workflow_run or manual input)
        id: resolve
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.OC_GH_TOKEN }}
          script: |
            const { owner, repo } = context.repo;

            if (context.eventName === 'workflow_dispatch') {
              const manualPr = core.getInput('pr');
              core.setOutput('pr', manualPr ? String(manualPr) : '');
              return;
            }

            const headSha = context.payload.workflow_run?.head_sha;
            if (!headSha) {
              core.setOutput('pr', '');
              return;
            }

            const prs = await github.paginate(
              github.rest.repos.listPullRequestsAssociatedWithCommit,
              { owner, repo, commit_sha: headSha, per_page: 100 }
            );

            const openPr = prs.find(pr => pr.state === 'open');
            core.setOutput('pr', openPr ? String(openPr.number) : '');

  fail-on-ci-failure:
    needs: resolve-pr
    if: github.event_name == 'workflow_run' && needs.resolve-pr.outputs.pr != '' && github.event.workflow_run.conclusion != 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Explicitly fail when CI is not green
        run: |
          echo "::error::CI checks are not successful (conclusion=${{ github.event.workflow_run.conclusion }}), refusing automerge for PR #${{ needs.resolve-pr.outputs.pr }}"
          exit 1

  merge-on-ci-success:
    needs: resolve-pr
    if: (github.event_name == 'workflow_dispatch' && needs.resolve-pr.outputs.pr != '') || (github.event_name == 'workflow_run' && needs.resolve-pr.outputs.pr != '' && github.event.workflow_run.conclusion == 'success')
    runs-on: ubuntu-latest
    steps:
      - name: Merge PR after required checks are green
        env:
          GH_TOKEN: ${{ secrets.OC_GH_TOKEN }}
          PR: ${{ needs.resolve-pr.outputs.pr }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          if gh pr merge "$PR" --repo "$REPO" --squash --delete-branch; then
            echo "Merged via repository branch protection policy"
            exit 0
          fi

          echo "::error::Automerge blocked. Required checks/reviews are not satisfied for PR #$PR"
          gh pr view "$PR" --repo "$REPO" --json url,mergeStateStatus,statusCheckRollup,reviewDecision
          exit 1

  no-pr-detected:
    needs: resolve-pr
    if: needs.resolve-pr.outputs.pr == ''
    runs-on: ubuntu-latest
    steps:
      - name: No matching open PR
        run: echo "No open PR associated with this trigger. Skipping automerge."
