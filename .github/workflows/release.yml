name: release

on:
  workflow_call:
    inputs:
      release_tag:
        required: true
        type: string
      upstream_tag:
        required: true
        type: string
      source_run_url:
        required: true
        type: string
  workflow_dispatch:
    inputs:
      release_tag:
        required: true
        type: string
      upstream_tag:
        required: true
        type: string
      source_run_url:
        required: false
        type: string
        default: manual

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Enforce single-token secret
        env:
          SINGLE_TOKEN: ${{ secrets.OC_GH_TOKEN }}
        run: |
          if [ -z "${SINGLE_TOKEN}" ]; then
            echo '{"error_code":"E_SINGLE_TOKEN_MISSING","required_secret":"OC_GH_TOKEN"}'
            exit 1
          fi

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref_name }}
          token: ${{ secrets.OC_GH_TOKEN }}

      - name: Normalize release tag
        id: normalize
        env:
          INPUT_RELEASE_TAG: ${{ inputs.release_tag }}
          UPSTREAM_TAG: ${{ inputs.upstream_tag }}
        run: |
          upstream_version="${UPSTREAM_TAG#v}"
          release_tag="overlay-v${upstream_version}"
          echo "upstream_version=${upstream_version}" >> "$GITHUB_OUTPUT"
          echo "release_tag=${release_tag}" >> "$GITHUB_OUTPUT"

      - name: Update CHANGELOG
        env:
          RELEASE_TAG: ${{ steps.normalize.outputs.release_tag }}
          UPSTREAM_TAG: ${{ inputs.upstream_tag }}
          SOURCE_RUN_URL: ${{ inputs.source_run_url }}
        run: |
          d="$(date -u +%Y-%m-%d)"
          if grep -q "^## ${RELEASE_TAG}" CHANGELOG.md; then
            echo "CHANGELOG already contains ${RELEASE_TAG}"
            exit 0
          fi
          cat > /tmp/changelog-entry.md <<EOF
          ## ${RELEASE_TAG} (${d})
          - auto-compat: support upstream ${UPSTREAM_TAG}
          - source run: ${SOURCE_RUN_URL}
          EOF
          cat /tmp/changelog-entry.md CHANGELOG.md > CHANGELOG.md.new
          mv CHANGELOG.md.new CHANGELOG.md

      - name: Commit changelog (skip protected main)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          if git diff --cached --quiet; then
            echo "No changelog changes to commit"
            exit 0
          fi
          if [ "${{ github.ref_name }}" = "main" ]; then
            echo "main is protected; skip committing changelog directly"
            exit 0
          fi
          git commit -m "chore(release): update changelog for ${{ steps.normalize.outputs.release_tag }}"
          git push origin HEAD:${{ github.ref_name }}

      - name: Create tag and release
        env:
          GH_TOKEN: ${{ secrets.OC_GH_TOKEN }}
          RELEASE_TAG: ${{ steps.normalize.outputs.release_tag }}
        run: |
          git fetch --tags
          if ! git rev-parse "${RELEASE_TAG}" >/dev/null 2>&1; then
            git tag "${RELEASE_TAG}"
            git push origin "${RELEASE_TAG}"
          fi
          cat > /tmp/release-notes.md <<EOF
          Auto-compat release for upstream ${{ inputs.upstream_tag }}.

          Source: ${{ inputs.source_run_url }}
          EOF
          gh release view "${RELEASE_TAG}" >/dev/null 2>&1 || gh release create "${RELEASE_TAG}" --title "${RELEASE_TAG}" --notes-file /tmp/release-notes.md
