name: release

on:
  workflow_call:
    inputs:
      release_tag:
        required: true
        type: string
      upstream_tag:
        required: true
        type: string
      source_run_url:
        required: true
        type: string
  workflow_dispatch:
    inputs:
      release_tag:
        required: true
        type: string
      upstream_tag:
        required: true
        type: string
      source_run_url:
        required: false
        type: string
        default: manual

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref_name }}
      - name: Update CHANGELOG
        env:
          RELEASE_TAG: ${{ inputs.release_tag }}
          UPSTREAM_TAG: ${{ inputs.upstream_tag }}
          SOURCE_RUN_URL: ${{ inputs.source_run_url }}
        run: |
          d="$(date -u +%Y-%m-%d)"
          entry="## ${RELEASE_TAG} (${d})\n- auto-compat: support upstream ${UPSTREAM_TAG}\n- source run: ${SOURCE_RUN_URL}\n"
          if grep -q "^## ${RELEASE_TAG}" CHANGELOG.md; then
            echo "CHANGELOG already contains ${RELEASE_TAG}"
          else
            { printf "%b\n" "$entry"; cat CHANGELOG.md; } > CHANGELOG.md.new
            mv CHANGELOG.md.new CHANGELOG.md
          fi
      - name: Commit changelog (skip protected main)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          if git diff --cached --quiet; then
            echo "No changelog changes to commit"
            exit 0
          fi
          if [ "${{ github.ref_name }}" = "main" ]; then
            echo "main is protected; skip committing changelog directly"
            exit 0
          fi
          git commit -m "chore(release): update changelog for ${{ inputs.release_tag }}"
          git push origin HEAD:${{ github.ref_name }}
      - name: Create tag and release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git fetch --tags
          if ! git rev-parse "${{ inputs.release_tag }}" >/dev/null 2>&1; then
            git tag "${{ inputs.release_tag }}"
            git push origin "${{ inputs.release_tag }}"
          fi
          gh release view "${{ inputs.release_tag }}" >/dev/null 2>&1 || gh release create "${{ inputs.release_tag }}" \
            --title "${{ inputs.release_tag }}" \
            --notes "Auto-compat release for upstream ${{ inputs.upstream_tag }}\n\nSource: ${{ inputs.source_run_url }}"
