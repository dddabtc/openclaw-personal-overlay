name: autofix-autoclose-on-success

"on":
  workflow_run:
    workflows:
      - auto-compat
      - overlay-ci
      - support-release-rollover
    types:
      - completed

permissions:
  contents: read
  actions: read
  issues: write

jobs:
  autoclose-resolved-autofix-issue:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Close matching open autofix issue if resolution observed
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          REPO='${{ github.repository }}'
          RUN_URL='${{ github.event.workflow_run.html_url }}'
          WORKFLOW='${{ github.event.workflow_run.name }}'
          BRANCH='${{ github.event.workflow_run.head_branch }}'
          DISPLAY_TITLE='${{ github.event.workflow_run.display_title }}'

          UPSTREAM_VERSION=$(printf '%s\n' "$DISPLAY_TITLE" | sed -nE 's/.*upstream[^0-9]*([0-9]+\.[0-9]+\.[0-9]+).*/\1/p' | head -n1)
          if [[ -z "${UPSTREAM_VERSION:-}" ]]; then
            UPSTREAM_VERSION="n/a"
          fi

          DEDUPE_KEY="${WORKFLOW}|${BRANCH}|${UPSTREAM_VERSION}"
          TITLE="[autofix] ${WORKFLOW} failed on ${BRANCH}"
          KEY_MARKER="<!-- autofix-key:${DEDUPE_KEY} -->"

          ISSUE_NUMBER=$(gh issue list \
            --repo "$REPO" \
            --state open \
            --label autofix \
            --limit 200 \
            --json number,title,body \
            --jq '.[] | select((.body // "") | contains("'"$KEY_MARKER"'")) | .number' | head -n1)

          if [[ -z "${ISSUE_NUMBER:-}" ]]; then
            ISSUE_NUMBER=$(gh issue list \
              --repo "$REPO" \
              --state open \
              --label autofix \
              --search "in:title \"$TITLE\"" \
              --limit 20 \
              --json number,title \
              --jq '.[] | select(.title == "'"$TITLE"'") | .number' | head -n1)
          fi

          if [[ -n "${ISSUE_NUMBER:-}" ]]; then
            gh issue comment "$ISSUE_NUMBER" --repo "$REPO" --body "Auto-closing: a newer successful run indicates this failure chain is resolved.\n\n- Key: `${DEDUPE_KEY}`\n- Resolved by run: $RUN_URL"
            gh issue close "$ISSUE_NUMBER" --repo "$REPO"
          else
            echo "No matching open autofix issue found for key: $DEDUPE_KEY"
          fi
